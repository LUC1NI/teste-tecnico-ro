@page "/products/list"
@inject HttpClient Http

<h3>Lista de Produtos</h3>

<div class="mb-3">
    <input type="text" class="form-control" placeholder="Buscar por nome" @bind="searchTerm" @bind:event="oninput" />
</div>

<table class="table table-striped">
    <thead>
        <tr>
            <th>Nome</th>
            <th>Descrição</th>
            <th>Preço</th>
            <th>Quantidade em Estoque</th>
        </tr>
    </thead>
    <tbody>
        @if (products is null)
        {
            <tr><td colspan="4">Carregando...</td></tr>
        }
        else if (products.Count == 0)
        {
            <tr><td colspan="4">Nenhum produto encontrado.</td></tr>
        }
        else
        {
            @foreach (var product in products)
            {
                <tr>
                    <td>@product.Name</td>
                    <td>@product.Description</td>
                    <td>@product.Price.ToString("C")</td>
                    <td>@product.StockQuantity</td>
                </tr>
            }
        }
    </tbody>
</table>

<nav>
    <ul class="pagination">
        <li class="page-item @(currentPage == 1 ? "disabled" : "")">
            <button class="page-link" @onclick="PrevPage">Anterior</button>
        </li>
        <li class="page-item disabled">
            <span class="page-link">Página @currentPage de @totalPages</span>
        </li>
        <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
            <button class="page-link" @onclick="NextPage">Próxima</button>
        </li>
    </ul>
</nav>

@code {
    private List<ProductModel>? products;
    private string searchTerm = string.Empty;
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        var response = await Http.GetAsync($"api/products?search={searchTerm}&page={currentPage}&pageSize={pageSize}");
        if (response.IsSuccessStatusCode)
        {
            var result = await response.Content.ReadFromJsonAsync<ProductListResponse>();
            if (result != null)
            {
                products = result.Items;
                totalPages = (int)Math.Ceiling((double)result.TotalCount / pageSize);
            }
        }
        else
        {
            products = new List<ProductModel>();
        }
    }

    private async Task PrevPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadProducts();
        }
    }

    private async Task NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            await LoadProducts();
        }
    }

    private class ProductModel
    {
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public decimal Price { get; set; }
        public int StockQuantity { get; set; }
    }

    private class ProductListResponse
    {
        public List<ProductModel> Items { get; set; } = new();
        public int TotalCount { get; set; }
    }
}
